---
tags: [aes, java, cpp]
layout: posts
---

# 카일레라란?


> Kaillera enables emulators to play on the Internet.
With Kaillera you can enjoy playing video games with others from all over the world.
it consists of a client and a server. The client is usually embedded into your favorite emulator and the server is a stand-alone application that needs to be run on a machine directly wired to the Internet.

Kaillera 는 에뮬레이터가 인터넷을 통해 같이 넷플레이를 하게끔 도와주는 서버/클라이언트 프로토콜의 지칭한다.

기본적으로 UDP 프로토콜을 쓰고 있으며, UDP 프로토콜 특성상 패킷 누락과 같은 현상을 보완하기 위해 서버/클라이언트쪽에서 항상 최근 패킷2개를 같이 던져준다.

예를 들어 패킷 하나를 들고오면 

```
0000   03 07 00 04 00 0b 00 ff ff 06 00 09 00 08 00 2e
0010   2e 2e 2e 2e 2e 00 05 00 0e 00 0c 00 00 00 00 00
0020   00 00 00 00 00 ff ff 02
Kaillera Protocol
    Messages: 3 -- 1 byte
    Message Seqeunce: 7 -- 2 bytes
    len(message): 4 -- 2 bytes
    Message Type: 0x0b -- 1 byte
    Message Seqeunce: 6
    len(message): 9
    Message Type: 0x08
    Message Seqeunce: 5
    len(message): 14
    Message Type: 0x0c
```

위와 같이 몇 개의 Messages 를 전송하는지 명시 하고 그 개수만큼 보내는 쪽이 최근 보낸 패킷들을 기억해서 전, 전전 패킷을 같이 보내준다.

그래서 서버/클라이언트는 항상 누락된 패킷에 대한 복구 로직이 있어야 하며, 만약 누락이 된다면 `게임 갈림` 현상이 일어난다.

# 특이한 게임 입력 동기화 시스템

두명의 플레이어가 게임을 하는 모습을 상상해보자.

어떻게 동기화할것인가? 일단 Kaillera 는 모든 참여자가 입력데이터를 전달해주면 서버가 입력 데이터를 취합하여 참여자들에게 입력값을 브로드캐스팅한다.

```
P1 -> Server: A 키
P2 -> Server: 아무키도 안누름
Server -> P1: 키입력정보
Server -> P2: 키입력정보
```

여기서 Kaillera 는 입력값에 대한 전송 바이트를 아끼기 위해 `GameData`, `GameCache` 개념을 사용한다.

# GameData, GameCache

`GameData` 는 실제 입력에 대한 데이터이고 `GameCache` 는 캐싱된 데이터에 대한 slot 위치를 다루는 방법이다.




